context("get_peak_chromatograms")

testOswFiles <- function(){
  df1 <- data.frame("transition_group_id" = rep("KLYAGAILEV_2", 2),
                    "filename" = rep("HLA-Ligand-Atlas/BD-ZH12_Spleen_Class-1/dia_files/170407_AM_BD-ZH12_Spleen_W_10%_DIA_#1_400-650mz_msms41.mzML", 2),
                    "RT" = c(4390.35, 4433.38),
                    "delta_rt" = c(66.94013, 109.96858),
                    "assay_RT" = rep(4326.335, 2),
                    "Intensity" = c(6644520, 914820),
                    "leftWidth" = c(4369.325, 4418.935),
                    "rightWidth" = c(4413.365, 4439.139),
                    "peak_group_rank" = c(1L, 2L),
                    "m_score" = c(0.002128436, 0.029838394),
                    "chromatogramIndex" = c("100743,104255,107437,109555,114846", "100743,104255,107437,109555,114846"),
                    "transition_ids" = c("45085,45089,45095,45098,45103", "45085,45089,45095,45098,45103"),
                    stringsAsFactors=FALSE)
  df1 <- dplyr::as_tibble(df1)
  df2 <- data.frame("transition_group_id" = c("AQPPVSTEY_2", "AQPVPAHVY_2", "KLYAGAILEV_2"),
                    "filename" = rep("HLA-Ligand-Atlas/BD-ZH12_Spleen_Class-1/dia_files/170407_AM_BD-ZH12_Spleen_W_10%_DIA_#2_400-650mz_msms42.mzML", 3),
                    "RT" = c(2646.83, 2288.47, 4393.37),
                    "delta_rt" = c(39.65983, -21.74987, 59.51805),
                    "assay_RT" = c(2591.269, 2291.749, 4326.335),
                    "Intensity" = c(3547210, 3160430, 6095270),
                    "leftWidth" = c(2635.629, 2272.900, 4373.91),
                    "rightWidth" = c(2658.890, 2297.921, 4411.6),
                    "peak_group_rank" = c(1L, 1L, 1L),
                    "m_score" = c(0.003287926, 0.003287926, 0.00388708),
                    "chromatogramIndex" = c("38090,38804,43646,46675,49639", "37861,38083,43271,49367,49907",
                                            "88248,91760,94942,97060,102351"),
                    "transition_ids" = c("19613,19614,19619,19623,19627", "17295,17296,17299,17302,17304",
                                         "45085,45089,45095,45098,45103"),
                    stringsAsFactors=FALSE)
  df2 <- dplyr::as_tibble(df2)
  oswFiles <- list("run0" = df1, "run1" = df2)
  oswFiles
}
intensityVector <- function(){
  intensity <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2282.601,6453.779,20206.19,33400.98,40637.6,53405.7,69031.24,80198.83,92819.47,94424.74,97595.16,100286.4,108191,110337,101159.9,94324.55,79041.08,68787.21,52891.16,45032.5,29300.59,21846.83,15108.02,12354.17,6559.634,8219.567,4632.184,3449.838,2944.814,3632.112,1115.419,-729.3113,1423.007,2015.927,1423.007,-355.7519,0,-688.1036,2752.414,3493.007,3711.457,3586.575, 7549.828,8627.862,5574.888,1762.643,-1050.344,1747.579,2475.737,1474.191,656.6565,1549.198,1093.551,-273.3878,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  intensity
}
timeVector <- function(){
  time <- c(4023.7,4025,4026.3,4027.6,4028.9,4030.2,4031.5,4032.8,4034.1,4035.4,4036.7,4038,4039.3,4040.6,4041.9,4043.1,4044.4,4045.7,4047,4048.2,4049.5,4050.9,4052.2,4053.5,4054.8,4056,4057.3,4058.6,4059.9,4061.2,4062.5,4063.8,4065.1,4066.4,4067.8,4069.1,4070.4,4071.7,4073,4074.3,4075.6,4076.9,4078.2,4079.5,4080.8,4082.1,4083.4,4084.7,4086,4087.4,4088.7,4090,4091.3,4092.6,4093.9,4095.2,4096.5,4097.8,4099.1,4100.4,4101.9,4103.2,4104.5,4105.8,4107.1,4108.4,4109.8,4111.1,4112.4,4113.7,4115.1,4116.4,4117.8,4119.1,4120.5,4121.9,4123.2,4124.6,4126,4127.4,4128.7,4130.1,4131.4,4132.8,4134.2,4135.5,4136.9,4138.2,4139.6,4140.9,4142.3,4143.6,4145,4146.3,4147.7,4149,4150.4,4151.7,4153.1,4154.4,4155.8,4157.2,4158.6,4159.9,4161.3,4162.7,4164.1,4165.5,4167,4168.4,4169.8,4171.2,4172.6,4174,4175.5,4176.9,4178.3,4179.7,4181.1,4182.5,4183.9,4185.3,4186.6,4188,4189.4,4190.8,4192.1,4193.4,4194.8,4196.1,4197.5,4198.8,4200.2,4201.5,4202.9,4204.2,4205.7,4207,4208.4,4209.8,4211.1,4212.5,4213.8,4215.2,4216.5,4217.9,4219.2,4220.5,4221.9,4223.2,4224.6,4225.9,4227.2,4228.6,4229.9,4231.2,4232.6,4233.9,4235.2,4236.6,4237.9,4239.2,4240.5,4241.8,4243.1,4244.4,4245.8,4247.1,4248.4,4249.7,4251.1,4252.4,4253.8,4255.1,4256.5,4257.9,4259.3,4260.6,4262,4263.3,4264.7,4266,4267.4,4268.7,4270.1,4271.4,4272.7,4274.1,4275.4,4276.8,4278.2,4279.6,4280.9,4282.3,4283.7,4285.1,4286.5,4287.9,4289.3,4290.7,4292,4293.4,4294.8,4296.2,4297.6,4298.9,4300.3,4301.7,4303,4304.4,4305.8,4307.1,4308.5,4310,4311.3,4312.7,4314,4315.4,4316.7,4318,4319.4,4320.7,4322.1,4323.4,4324.8,4326.1,4327.5,4328.9,4330.2,4331.6,4332.9,4334.3,4335.7,4337,4338.4,4339.7,4341.1,4342.5,4343.9,4345.3,4346.7,4348.1,4349.5,4350.9,4352.3,4353.7,4355.1,4356.4,4357.8,4359.2,4360.6,4362.2,4363.6,4365,4366.4,4367.9,4369.3,4370.8,4372.2,4373.6,4375.1,4376.5,4378,4379.4,4380.9,4382.3,4383.8,4385.2,4386.7,4388.1,4389.5,4391,4392.4,4393.8,4395.3,4396.7,4398.1,4399.6,4401,4402.4,4403.8,4405.1,4406.5,4407.9,4409.3,4410.6,4412,4413.4,4414.9,4416.2,4417.6,4418.9,4420.3,4421.6,4423,4424.3,4425.7,4427,4428.4,4429.7,4431.1,4432.4,4433.8,4435.1,4436.5,4437.8,4439.1,4440.5,4441.8,4443.2,4444.5,4445.9,4447.3,4448.7,4450.1,4451.5,4452.9,4454.3,4455.7,4457.1,4458.5,4459.9,4461.2,4462.6,4464,4465.3,4466.8,4468.2,4469.6,4470.9,4472.3,4473.6,4475,4476.4,4477.7,4479.1,4480.5,4481.9,4483.3,4484.7,4486.1,4487.5,4489,4490.4,4492,4493.6,4495.3,4496.9,4498.5,4500.1,4501.6,4503.1,4504.5,4505.9,4507.4,4508.8,4510.2,4511.6,4513,4514.4,4515.9,4517.3,4518.8,4520.2,4521.6,4523,4524.5,4525.9,4527.3,4528.7,4530.1,4531.5,4532.9,4534.4,4535.8,4537.2,4538.6,4540,4541.4,4542.8,4544.2,4545.6,4547,4548.4,4549.8,4551.2,4552.7,4554,4555.4,4556.8,4558.2,4559.6,4561,4562.4,4563.7,4565.1,4566.5,4567.9,4569.2,4570.8,4572.1,4573.5,4574.8,4576.2,4577.5,4578.9,4580.2,4581.6,4582.9,4584.2,4585.6,4586.9,4588.3,4589.6,4591,4592.3,4593.6,4595,4596.4,4597.7,4599.1,4600.5,4601.9,4603.2,4604.6,4606,4607.4,4608.8,4610.2,4611.6,4613,4614.4,4615.9,4617.3,4618.8,4620.2,4621.8,4623.3)
  time
}

test_that("test_extractXIC_group", {
  mzmlName <- "../../data/testData2/mzml/170407_AM_BD-ZH12_Spleen_W_10%_DIA_#1_400-650mz_msms41.chrom.mzML"
  mz <- mzR::openMSfile(mzmlName, backend = "pwiz")
  chromIndices <- c(100743L, 104255L, 107437L, 109555L, 114846L)
  outData <- extractXIC_group(mz, chromIndices, SgolayFiltOrd = 3, SgolayFiltLen = 5)
  expIntensity <- intensityVector()
  expTime <- timeVector()

  expect_identical(length(outData), 5L)
  expect_equal(outData[[2]][,1], expTime, tolerance = 1e-04)
  expect_equal(outData[[2]][,2], expIntensity, tolerance = 1e-04)
})

test_that("test_getXICs4AlignObj", {
  dataPath <- "../../data/testData2"
  runs <- c("run0" = "170407_AM_BD-ZH12_Spleen_W_10%_DIA_#1_400-650mz_msms41",
            "run1" = "170407_AM_BD-ZH12_Spleen_W_10%_DIA_#2_400-650mz_msms42")
  data(oswFiles_DIAlignR, package="DIAlignR")
  oswFiles <- oswFiles_DIAlignR
  analytes <- "KLYAGAILEV_2"
  outData <- getXICs4AlignObj(dataPath, runs, oswFiles, analytes,
                   SgolayFiltOrd = 4, SgolayFiltLen = 5)
  data(XIC_KLYAGAILEV_2_DIAlignR, package="DIAlignR")
  XICs <- XIC_KLYAGAILEV_2_DIAlignR
  expect_identical(names(outData), c("run0", "run1"))
  expect_identical(names(outData[[2]]), "KLYAGAILEV_2")
  expect_equal(outData[["run0"]][["KLYAGAILEV_2"]], XICs[["run0"]][["KLYAGAILEV_2"]], tolerance = 1e-03)
  expect_equal(outData[["run1"]][["KLYAGAILEV_2"]], XICs[["run1"]][["KLYAGAILEV_2"]], tolerance = 1e-03)
})

test_that("test_getMappedRT", {
  data(XIC_KLYAGAILEV_2_DIAlignR, package="DIAlignR")
  XICs <- XIC_KLYAGAILEV_2_DIAlignR
  data(oswFiles_DIAlignR, package="DIAlignR")
  oswFiles <- oswFiles_DIAlignR
  XICs.ref <- XICs[["run2"]][[1]]
  XICs.eXp <- XICs[["run0"]][[1]]
  adaptiveRT <- 90.56635 #3.5*Loess.fit$s
  Loess.fit <- getLOESSfit(oswFiles, ref = "run2", eXp = "run0", maxFdrLoess = 0.05, spanvalue = 0.1)
  outData <- getMappedRT(refRT = 4449.35, XICs.ref, XICs.eXp, Loess.fit, alignType = "hybrid",
                        adaptiveRT = 90.56635, samplingTime = 1.372082,
                        normalization = "mean", simMeasure = "dotProductMasked",
                        goFactor = 0.125, geFactor = 40, cosAngleThresh = 0.3,
                        OverlapAlignment = TRUE,
                        dotProdThresh = 0.96, gapQuantile = 0.5, hardConstrain = FALSE,
                        samples4gradient = 100)
  expect_equal(outData, 4388.1, tolerance = 1e-03)
})

test_that("test_getAlignObj", {

})
